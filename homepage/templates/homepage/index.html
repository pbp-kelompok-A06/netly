{% extends "base.html" %}
{% load static %}

{% block title %}Netly - Find & Book Badminton Courts{% endblock %}

{% block meta %}
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html {
        overflow-y: scroll; 
    }

    /* Buttons */
    .btn-primary {
      background-color: #243153;
      color: #D7FC64;
      padding: 0.6rem 1.2rem;
      border-radius: 9999px;
      font-weight: 600;
      transition: all 0.15s ease;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .btn-primary:hover {
      background-color: #2F3F61;
      transform: scale(1.02);
      box-shadow: 0 8px 18px rgba(36,49,83,0.12);
    }

    /* Cards */
    .court-card { transition: all 0.28s ease-in-out; }
    .court-card:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 14px 30px rgba(2,6,23,0.06); }

    .badge {
      position: absolute; top: 12px; left: 12px;
      background: #D7FC64; color: #243153;
      font-size: 0.75rem; padding: 0.22rem 0.7rem;
      border-radius: 9999px; font-weight: 600;
      letter-spacing: 0.2px;
    }

    .feature-icon { background-color: #243153; color: #D7FC64; }

  </style>
{% endblock %}

{% block content %}

    <section id="search" class="relative z-20 mt-8">
    <div class="max-w-5xl mx-auto px-4">
        <form method="get" action="{% url 'homepage:homepage' %}" 
            class="bg-white shadow-md rounded-xl flex items-center gap-3 p-4 md:p-5"
            id="search-form">

        <input 
        type="text" 
        name="q"
        value="{{ search_query|default:'' }}"
        placeholder="Search courts..." 
        class="flex-grow px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-[#00B894] outline-none text-sm"
        id="search-input"
        />

        <div class="relative">
            
            <button 
            id="filterBtn" 
            type="button"
            class="p-3 rounded-full bg-[#0A2647] text-white hover:bg-[#0C315C] transition"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L15 13.414V19a1 1 0 01-.553.894l-4 2A1 1 0 019 21v-7.586L3.293 6.707A1 1 0 013 6V4z" />
                </svg>
            </button>

            <div id="filterCard" class="hidden absolute top-full right-0 mt-2 w-72 sm:w-80 bg-white border border-gray-200 rounded-lg shadow-xl p-5 z-50 animate-fade">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Filters</h3>

                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Location</label>
                    <select id="filter-location" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-[#00B894] outline-none">
                        <option value="">Select Location</option>
                        <option>Jakarta Barat</option>
                        <option>Jakarta Selatan</option>
                        <option>Jakarta Utara</option>
                        <option>Jakarta Pusat</option>
                        <option>Jakarta Timur</option>
                        <option>Tangerang</option>
                        <option>Tangerang Selatan</option>
                        <option>Depok</option>
                        <option>Surabaya</option>
                        <option>Malang</option>
                        <option>Kupang</option>
                        <option>Bandung</option>
                        <option>Bogor</option>
                        <option>Bantul</option>
                        <option>Medan</option>
                        <option>Pekanbaru</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Min Price</label>
                        <input id="filter-min" type="number" placeholder="Rp" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-[#00B894] outline-none" />
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Max Price</label>
                        <input id="filter-max" type="number" placeholder="Rp" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-[#00B894] outline-none" />
                    </div>
                </div>

                <button id="applyFilterBtn" class="mt-4 w-full bg-[#0A2647] text-white rounded-lg py-2 font-semibold hover:bg-[#0C315C] text-sm transition">
                    Apply Filter
                </button>
            </div>
        
        </div>

        <button 
        type="submit"
        class="bg-[#243153] text-[#D7FC64] px-6 py-3 rounded-full font-semibold hover:bg-[#2F3F61] w-full sm:w-auto transition shadow-md"
        id="search-btn"
        >
            Search
        </button>
    </form>

    </div>
    </section>


  <section class="max-w-5xl mx-auto px-4 mt-8 pb-20">

    <div id="court-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
      {% for court in court_list %}
              <a href="{% url 'homepage:court-detail' court.id %}"
              class="block bg-white rounded-2xl shadow-md overflow-hidden relative court-card transition-all hover:scale-[1.01] hover:shadow-lg h-full flex flex-col border border-gray-100">

                  <div class="h-48 w-full overflow-hidden bg-gray-100">
                      {% if court.image %}
                          <img src="{{ court.image }}" alt="{{ court.name }}" class="w-full h-full object-cover">
                      {% else %}
                          <div class="w-full h-full flex items-center justify-center text-gray-400">No Image</div>
                      {% endif %}
                  </div>

                  <div class="p-5 flex flex-col flex-grow">
                      <h3 class="text-lg font-bold text-slate-800 leading-tight mb-1">{{ court.name }}</h3>
                      <p class="text-sm text-gray-500 mb-4">{{ court.location|default:"Location not available" }}</p>
                      
                      <div class="mt-auto pt-3 border-t border-gray-100">
                          <span class="text-lg font-bold text-[#243153]">Rp {{ court.formatted_price }}</span>
                      </div>
                  </div>

              </a>
            {% empty %}
        <div class="col-span-full text-center py-20 text-gray-500">
             <p class="text-lg font-medium">No courts available.</p>
        </div>
      {% endfor %}
    </div>

<script defer>
document.addEventListener("DOMContentLoaded", () => {
  console.log("âœ… Script loaded...");

  // --- HELPER: FORMAT RUPIAH (Global) ---
  const formatRupiah = (num) => {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
  };

  // Loop semua elemen harga yang dirender Django, lalu format pake JS biar ada titiknya
  const initialPrices = document.querySelectorAll('.initial-price');
  initialPrices.forEach(el => {
      const rawPrice = parseFloat(el.getAttribute('data-price'));
      if (!isNaN(rawPrice)) {
          el.textContent = formatRupiah(rawPrice);
      }
  });

  // Elements
  const filterBtn = document.getElementById("filterBtn");
  const filterCard = document.getElementById("filterCard");
  const applyFilterBtn = document.getElementById("applyFilterBtn");
  const locationSelect = document.getElementById("filter-location");
  const searchForm = document.getElementById("search-form");
  const searchInput = document.getElementById("search-input");
  const searchBtn = document.getElementById("search-btn");
  const minInput = document.getElementById("filter-min");
  const maxInput = document.getElementById("filter-max");
  const courtContainer = document.getElementById("court-grid");

  // Toggle Filter
  if (filterBtn && filterCard) {
    filterBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      filterCard.classList.toggle("hidden");
    });
  }

  // Close Filter Outside
  document.addEventListener("click", (e) => {
    if (filterCard && filterBtn && !filterCard.contains(e.target) && !filterBtn.contains(e.target)) {
      filterCard.classList.add("hidden");
    }
  });

  // RENDER COURTS LIST (Saat Search/Filter)
  function renderCourtsList(courts) {
    if (!courtContainer) return;
    courtContainer.innerHTML = "";

    if (!courts || courts.length === 0) {
      courtContainer.innerHTML = `
        <div class="col-span-full text-center py-20 text-gray-500">
             <p class="text-lg font-medium">No courts found.</p>
        </div>`;
      return;
    }

    const html = courts.map(court => {
      const detailUrl = `/court/${court.id}/`;
      const image = court.image || "https://via.placeholder.com/400x300?text=No+Image";
      const location = court.location || "Location not available";

      return `
        <a href="${detailUrl}" 
        class="block bg-white rounded-2xl shadow-md overflow-hidden relative court-card transition-all hover:scale-[1.01] hover:shadow-lg h-full flex flex-col border border-gray-100">
          
          <div class="h-48 w-full overflow-hidden bg-gray-100">
              <img src="${image}" alt="${court.name}" class="w-full h-full object-cover">
          </div>

          <div class="p-5 flex flex-col flex-grow">
              <h3 class="text-lg font-bold text-slate-800 leading-tight mb-1">${court.name}</h3>
              <p class="text-sm text-gray-500 mb-4">${location}</p>
              
              <div class="mt-auto pt-3 border-t border-gray-100">
                 <span class="text-lg font-bold text-[#243153]">${formatRupiah(court.price)}</span>
              </div>
          </div>
        </a>
      `;
    }).join("");

    courtContainer.innerHTML = html;
  }

  async function applyFilter() {
    try {
      const params = new URLSearchParams();
      const q = searchInput?.value.trim();
      const location = locationSelect?.value;
      const minPrice = minInput?.value;
      const maxPrice = maxInput?.value;

      if (q) params.append("q", q);
      if (location) params.append("location", location);
      if (minPrice) params.append("min_price", minPrice);
      if (maxPrice) params.append("max_price", maxPrice);

      const res = await fetch(`/filter-courts/?${params.toString()}`, { credentials: 'same-origin' });
      const data = await res.json();

      renderCourtsList(data.results);
      if (filterCard) filterCard.classList.add("hidden");
    } catch (err) {
      console.error("applyFilter error:", err);
    }
  }

  async function performSearch(q) {
    try {
      const res = await fetch(`/filter-courts/?q=${encodeURIComponent(q)}`, { credentials: 'same-origin' })
      const data = await res.json();
      renderCourtsList(data.results);
    } catch (err) {
      console.error("search error:", err);
    }
  }

  // EVENT LISTENERS
  if (searchForm) {
    searchForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const q = (searchInput.value || "").trim();
      performSearch(q);
    });
  }

  if (searchBtn) {
    searchBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const q = (searchInput.value || "").trim();
      performSearch(q);
    });
  }

  if (searchInput) {
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const q = (searchInput.value || "").trim();
        performSearch(q);
      }
    });
  }

  if (applyFilterBtn) {
    applyFilterBtn.addEventListener("click", (e) => {
      e.preventDefault();
      applyFilter();
    });
  }

});
</script>
{% endblock %}