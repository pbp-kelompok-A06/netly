{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>My Booking</title>
{% endblock meta %}

{% block content %}
<div class="bg-gray-50 w-full min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Your Booking History</h1>
        
        <div id="loading-list-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
            <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <p class="text-gray-600 mt-3">Loading bookings...</p>
        </div>

        <div id="error-list-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
            <div class="w-16 h-16 mx-auto mb-4">
                <div class="text-red-500 text-5xl">⚠️</div>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Failed to load bookings</h3>
            <p class="text-gray-500">Please check your network and try again.</p>
        </div>

        <div id="bookings-list-container" class="shadow overflow-hidden border border-gray-200 sm:rounded-lg hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Lapangan
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Booking Date
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th scope="col" class="relative px-6 py-3">
                            <span class="sr-only">Detail</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="bookings-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
        
        <div id="no-bookings-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
             <p class="text-gray-600">You haven't made any bookings yet.</p>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    // Configuration
    
    const ALL_BOOKINGS_ENDPOINT = `{% url 'booking:show_json' %}`;
    
    const DETAIL_PAGE_URL = `{% url 'booking:booking_detail' 'PLACEHOLDER_ID' %}`;

    // DOM Elements
    const loadingListState = document.getElementById('loading-list-state');
    const errorListState = document.getElementById('error-list-state');
    const bookingsListContainer = document.getElementById('bookings-list-container');
    const bookingsTableBody = document.getElementById('bookings-table-body');
    const noBookingsState = document.getElementById('no-bookings-state');

    // Utility to show/hide states
    function showListState(state) {
        loadingListState.classList.toggle('hidden', state !== 'loading');
        errorListState.classList.toggle('hidden', state !== 'error');
        bookingsListContainer.classList.toggle('hidden', state !== 'ready' || bookingsTableBody.children.length === 0);
        noBookingsState.classList.toggle('hidden', state !== 'ready' || bookingsTableBody.children.length > 0);
    }

    // Function to get the Tailwind class for the status badge
    function getStatusBadgeClass(status) {
        switch (status) {
            case 'pending':
                return 'bg-red-100 text-red-800';
            case 'completed':
                return 'bg-green-100 text-green-800';
            case 'failed':
                return 'bg-gray-100 text-gray-800';
            default:
                return 'bg-blue-100 text-blue-800';
        }
    }

    // Render the list of bookings in the table
    function renderBookingsList(bookings) {
        bookingsTableBody.innerHTML = ''; // Clear previous content

        if (bookings.length === 0) {
            showListState('ready'); // Show the "No Bookings" state
            return;
        }

        bookings.forEach(booking => {
            const row = bookingsTableBody.insertRow();
            row.className = 'hover:bg-gray-50'; // Add hover effect

            // 1. Lapangan (Field Name)
            let cellLapangan = row.insertCell();
            cellLapangan.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900';
            // Use 'lapangan.nama' if 'lapangan.name' is undefined
            cellLapangan.textContent = booking.lapangan.name || booking.lapangan.nama; 

            // 2. Booking Date (Created At)
            let cellDate = row.insertCell();
            cellDate.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
            const formattedDate = new Date(booking.created_at).toLocaleDateString('en-US', { 
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            cellDate.textContent = formattedDate;

            // 3. Status
            let cellStatus = row.insertCell();
            cellStatus.className = 'px-6 py-4 whitespace-nowrap';
            const statusBadge = document.createElement('span');
            statusBadge.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(booking.status_book)}`;
            statusBadge.textContent = booking.status_book;
            cellStatus.appendChild(statusBadge);

            // 4. Detail Button
            let cellDetail = row.insertCell();
            cellDetail.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
            const detailLink = document.createElement('a');
            detailLink.href = DETAIL_PAGE_URL.replace('PLACEHOLDER_ID', booking.id);
            detailLink.textContent = 'View Detail';
            detailLink.className = 'text-indigo-600 hover:text-indigo-900';
            cellDetail.appendChild(detailLink);
        });
        
        showListState('ready');
    }

    // Fetch all bookings
    async function loadBookings() {
        try {
            showListState('loading');
            
            const response = await fetch(ALL_BOOKINGS_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });

            if (!response.ok) {
                throw new Error('Failed to fetch bookings list');
            }
            
            const bookingsData = await response.json();
            // Assuming the JSON response is an array of booking objects: [{...}, {...}]
            renderBookingsList(bookingsData);
        } catch (error) {
            console.error('Error loading bookings list:', error);
            showListState('error');
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', loadBookings);
</script>
{% endblock extra_js %}