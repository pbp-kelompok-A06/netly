{% extends "base.html" %}
{% load static %}
{% block title %}all events{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10" style="padding-top: 1rem;"> 
    
    <div class="bg-white rounded-lg shadow-lg pt-6 px-6 pb-2 mb-5">
        <h1 class="text-3xl font-bold text-gray-900 mb-1">
            <span class="text-[#243153]">Badminton</span>
            <span class="text-[#c0ed3b]">Events</span>
        </h1>
        <p class="text-md text-gray-500 mb-2"> {# Styling subtitle #}
            Join event or tournament and be the champion
        </p>

        <div class="bg-white rounded-lg shadow-md p-4 mb-6"> 
            <div class="flex gap-4 items-center">   
                <div class="relative w-full text-left">
                    <div>
                        <button type="button" id="sort-menu-button" class="inline-flex justify-center w-full rounded-full border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none" aria-expanded="true" aria-haspopup="true">
                            Sort Date: {{ current_sort_label }}
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <div id="sort-menu" class="hidden origin-top-left absolute left-0 mt-2 w-full rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10" role="menu" aria-orientation="vertical" aria-labelledby="sort-menu-button" tabindex="-1">
                        <div class="py-1" role="none">
                            <a href="?sort=asc" class="text-gray-700 block px-4 py-2 text-sm {% if current_sort_label == 'Earliest' %}bg-gray-100{% endif %}" role="menuitem" tabindex="-1">
                                Earliest (Ascending)
                            </a>
                            <a href="?sort=desc" class="text-gray-700 block px-4 py-2 text-sm {% if current_sort_label == 'Latest' %}bg-gray-100{% endif %}" role="menuitem" tabindex="-1">
                                Latest (Descending)
                            </a>
                        </div>
                    </div>
                </div>

                <div class="w-full"> 
                    {% if user.is_authenticated and user.profile.role == 'admin' %}
                    <button 
                        onclick="showCreateModal()" 
                        class="inline-flex items-center justify-center w-full px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-[#D7FC64] bg-[#243153] hover:bg-opacity-90">
                        Add New Event
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div id="event-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% if events %}
            {% for event in events %}
                {% include 'card_event.html' with event=event %}
            {% endfor %} 
        {% else %}
            <p class="col-span-full text-center text-gray-500">No events scheduled right now.</p>
        {% endif %} 
    </div>
</div>

{% include 'event_modal.html' %}
{% include 'event_delete_modal.html' %}
{% include 'toast.html' %}  
{% endblock content %}

{% block javascript %}
<script src="{% static 'js/toast.js' %}"></script>

<!-- default image kala user ga update image -->
<script>
    const defaultImageUrl = "{% static 'image/default.jpg' %}"; 
</script>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // untuk create atau edit modal
    const eventModal = document.getElementById('eventModal');
    const eventModalContent = document.getElementById('eventModalContent');
    const eventForm = document.getElementById('eventForm');
    const eventModalTitle = document.getElementById('modalTitle');
    const eventModalSubtitle = document.getElementById('modalSubtitle');
    const eventSubmitButton = document.getElementById('submitButton');
    const eventIdInput = document.getElementById('eventId'); // Input 'hidden' untuk ID

    // untuk delete modal
    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');
    let eventIdToDelete = null;

    // url templates dari event_modal.html
    const createUrl = eventForm.dataset.createUrl;
    const editUrlTemplate = eventForm.dataset.editUrlTemplate;
    const getJsonUrlTemplate = "{% url 'event:get_event_json' '00000000-0000-0000-0000-000000000000' %}";
    const deleteUrlTemplate = "{% url 'event:delete_event_ajax' '00000000-0000-0000-0000-000000000000' %}";

    
    // menampilkan or menyembunyikan modal create atau edit
    function showEventModal() {
        eventModal.classList.remove('hidden');
        setTimeout(() => eventModalContent.classList.add('opacity-100', 'scale-100'), 50);
    }

    function hideEventModal() {
        eventModalContent.classList.remove('opacity-100', 'scale-100');
        setTimeout(() => eventModal.classList.add('hidden'), 150);
    }

    // untuk menampilkan atau menyembunyikan modal delete
    function showDeleteModal(eventId) {
        eventIdToDelete = eventId;
        deleteModal.classList.remove('hidden');
    }

    function hideDeleteModal() {
        eventIdToDelete = null;
        deleteModal.classList.add('hidden');
    }

    // CRUD
    // untuk mode create
    function showCreateModal() {
        eventForm.reset(); 
        eventIdInput.value = ''; 
        eventModalTitle.textContent = 'Create New Event';
        eventModalSubtitle.textContent = 'Fill out the form to add a new event';
        eventSubmitButton.textContent = 'Add Event';
        
        // set URL form ke endpoint 'create' -> karena modal sama dengan edit, jadi harus set attribute
        eventForm.setAttribute('data-action-url', createUrl);
        
        showEventModal(); 
    }

    // untuk dropdown sort 
    document.addEventListener('DOMContentLoaded', function() {
        const sortButton = document.getElementById('sort-menu-button');
        const sortMenu = document.getElementById('sort-menu');

        if (sortButton && sortMenu) {
            // tampilkan atau sembunyikan menu saat tombol diklik
            sortButton.addEventListener('click', function() {
                sortMenu.classList.toggle('hidden');
            });

            // hide menu saat mengklik di luar
            document.addEventListener('click', function(event) {
                if (!sortButton.contains(event.target) && !sortMenu.contains(event.target)) {
                    sortMenu.classList.add('hidden');
                }
            });
        }
    });

    // untuk edit
    async function showEditModal(eventId) {
        eventForm.reset();
        
        // ambil data event dari server
        const getUrl = getJsonUrlTemplate.replace('00000000-0000-0000-0000-000000000000', eventId);
        
        try {
            const response = await fetch(getUrl);
            if (!response.ok) throw new Error('Failed to fetch event data.');
            
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message || 'Could not find data.');

            const event = result.data;
            
            // pre-fill formnya karna ini untuk edit
            document.getElementById('eventId').value = event.id;
            document.getElementById('name').value = event.name;
            document.getElementById('description').value = event.description;
            document.getElementById('start_date').value = event.start_date.slice(0, 10);
            document.getElementById('end_date').value = event.end_date.slice(0, 10);
            document.getElementById('location').value = event.location;
            document.getElementById('image_url').value = event.image_url;
            document.getElementById('max_participants').value = event.max_participants;

            // untuk edit
            eventModalTitle.textContent = 'Edit Event';
            eventModalSubtitle.textContent = 'Update your event details';
            eventSubmitButton.textContent = 'Update Event';

            // set URL form ke endpoint 'edit'
            const editUrl = editUrlTemplate.replace('00000000-0000-0000-0000-000000000000', eventId);
            eventForm.setAttribute('data-action-url', editUrl);

            // show modal
            showEventModal();

        } catch (error) {
            console.error('Error in showEditModal:', error);
            showToast('Error: ' + error.message);
        }
    }

    // helper function untuk format date
    function formatDate(isoDateString) {
        const date = new Date(isoDateString);
        const options = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
        return date.toLocaleDateString('en-GB', options); // format akhirnya jadi: Wed, 29 Oct 2025
    }

    // listener untuk create atau edit event modal -> modalnya sama, url yang dihandle beda
    // yang diatur di 'data-action-url' oleh showCreateModal atau showEditModal
    eventForm.addEventListener('submit', async function(e) {
        e.preventDefault(); 
        
        // ambil url untuk cek user sedang mau create atau edit
        const url = eventForm.getAttribute('data-action-url');
        if (!url) {
            return;
        }

        const formData = new FormData(eventForm);

        try {
            const response = await fetch(url, {
                method: "POST",
                body: formData,
                headers: { 
                    "X-CSRFToken": csrftoken,
                    "X-Requested-With": "XMLHttpRequest" 
                }
            });
            
            const data = await response.json(); 

            if (data.status === 'success') {
                hideEventModal();
                showToast('Success!', data.message, 'success');

                // cek apakah ini hasil EDIT (ada data yang diupdate -> 'updated_event')
                if (data.updated_event) {
                    const updatedEvent = data.updated_event;
                    
                    // cari kartu yang sesuai berdasarkan data-event-id
                    const cardElement = document.querySelector(`[data-event-id="${updatedEvent.id}"]`);

                    if (cardElement) {
                        // find elemen di dalam kartu dan update isinya
                        const nameElement = cardElement.querySelector('.event-name');
                        if (nameElement) nameElement.textContent = updatedEvent.name;

                        const dateElement = cardElement.querySelector('.event-date');
                        if (dateElement) dateElement.textContent = formatDate(updatedEvent.start_date); 

                        const locationElement = cardElement.querySelector('.event-location');
                        if (locationElement) locationElement.textContent = updatedEvent.location;
                        
                        const imageElement = cardElement.querySelector('.event-image');
                        if (imageElement) {
                           imageElement.src = updatedEvent.image_url || defaultImageUrl; 
                           imageElement.alt = "Event image for " + updatedEvent.name; 
                        }
                    }
                } else {
                    // kalau hasil CREATE, reload halaman untuk menampilkan kartu baru
                    setTimeout(() => {
                        window.location.reload(); 
                    }, 1000); 
                }

            } else {
                const errorMsg = data.errors ? JSON.stringify(data.errors) : data.message;
                showToast('Error', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            showToast('Error', 'An unexpected error occurred.', 'error');
        }
    });

    // listener untuk delete button
    confirmDeleteButton.addEventListener('click', async () => {
        if (!eventIdToDelete) return;

        // simpan url lengkap untuk menuju delete_event_ajax di views.py
        const deleteUrl = deleteUrlTemplate.replace('00000000-0000-0000-0000-000000000000', eventIdToDelete);

        // kirim sinyal POST ke deleteUrl -> urls.py akan terusin ke delete_event_ajax()
        try {
            const response = await fetch(deleteUrl, {
                method: "POST",
                headers: { 
                    "X-CSRFToken": csrftoken,
                    "X-Requested-With": "XMLHttpRequest"
                },
            });

            const result = await response.json();

            if (result.status === 'success') {
                showToast('Success!', result.message, 'success');
            } else {
                showToast('Error', result.message || 'Failed to delete event.', 'error');
            }
        } catch (error) {
            console.error('Delete error:', error);
            showToast('Error', 'An error occurred. Please try again.', 'error');
        } finally {
            hideDeleteModal();
        }
    });

</script>
{% endblock javascript %}